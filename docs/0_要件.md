# 7 色電子ペーパー用 画像生成 API 要件定義書

## 1. プロジェクト概要

**目的**: 800x480 ピクセルの 7 色電子ペーパー（ACeP 方式）に表示するための画像を、Web API 経由で動的に生成・配信するシステムを構築する。
**優先事項**: 開発の容易さと保守性（Vercel + Next.js 構成）。

## 2. システム構成・技術スタック

| カテゴリ             | 技術選定                       | 選定理由                                                                              |
| -------------------- | ------------------------------ | ------------------------------------------------------------------------------------- |
| **インフラ**         | **Vercel**                     | 設定不要で Node.js 環境が使え、`sharp`等のライブラリが動作するため。                  |
| **フレームワーク**   | **Next.js (App Router)**       | API Routes の実装が容易で、Vercel との親和性が最高。                                  |
| **画像生成**         | **Satori** (vercel/satori)     | HTML/CSS (JSX) 構文で画像レイアウトを作成できるため保守性が高い。                     |
| **ラスタライズ**     | **@resvg/resvg-js**            | Satori が出力した SVG を正確かつ高速に PNG バッファへ変換するため。                   |
| **画像処理**         | **sharp**                      | 画像のリサイズ、バッファ操作、フォーマット変換を行う標準ライブラリ。                  |
| **減色アルゴリズム** | **Custom Script (TypeScript)** | 7 色パレットへの近似＋フロイド-スタインバーグ・ディザリング（誤差拡散法）を自前実装。 |

## 3. 機能要件

### 3.1 画像生成 API

- **エンドポイント**: `GET /api/epaper` (仮)
- **入力**: なし（将来的にはクエリパラメータで表示内容を変更可能にする）
- **処理フロー**:

1. **レンダリング**: JSX (HTML/CSS) を定義し、Satori で SVG 化する。
2. **PNG 変換**: SVG を PNG バイナリに変換する。
3. **Raw データ化**: `sharp` を使用して、画素データ（RGBA 配列）を取得する。
4. **減色処理 (Dithering)**: 全ピクセルを走査し、指定の 7 色パレットに変換しつつ、量子化誤差を周辺ピクセルに拡散する。
5. **エンコード**: 処理後のデータを PNG 形式にエンコードする。

- **出力**: `image/png` バイナリデータ。
- **レスポンスヘッダー**: `Content-Type: image/png`

### 3.2 画面仕様（初期フェーズ）

- **解像度**: 横 800px × 縦 480px (横置き基準)
- **コンテンツ**: 現時点では仮置き（Placeholder）。
- 例：「Hello World」のテキスト、現在時刻、簡単な図形を表示し、7 色が正しく出ているか確認できるテストパターンを含むこと。

## 4. 色定義と減色ロジック

### 4.1 対応パレット (7 色)

電子ペーパーの特性に合わせた以下の RGB 値を定義値として使用する。

```typescript
const PALETTE = [
  { id: "black", rgb: [0, 0, 0] }, // 黒
  { id: "white", rgb: [255, 255, 255] }, // 白
  { id: "green", rgb: [0, 255, 0] }, // 緑
  { id: "blue", rgb: [0, 0, 255] }, // 青
  { id: "red", rgb: [255, 0, 0] }, // 赤
  { id: "yellow", rgb: [255, 255, 0] }, // 黄
  { id: "orange", rgb: [255, 128, 0] }, // オレンジ
];
```

### 4.2 ディザリング手法

- **アルゴリズム**: フロイド-スタインバーグ・ディザリング (Floyd–Steinberg dithering)。
- **目的**: 単純な近似（Nearest Neighbor）では潰れてしまうグラデーションや中間色を、ドットの密度で擬似的に表現するため。

### 4.3 色パレットの管理

- **設定ファイル化**: 色パレットは設定ファイル（JSON/TypeScript）として外部化し、実機の色特性に合わせて後から調整可能にする。

## 5. エラーハンドリング

### 5.1 エラーレスポンス

- **HTTP ステータスコード**:

  - `200 OK`: 正常に画像生成できた場合
  - `400 Bad Request`: リクエストパラメータが不正な場合
  - `500 Internal Server Error`: サーバー側の処理エラーが発生した場合

- **エラーレスポンス形式**:

```json
{
  "error": "エラーメッセージ",
  "code": "ERROR_CODE"
}
```

### 5.2 エラーケース

- 画像生成処理の失敗（Satori、sharp などのライブラリエラー）
- メモリ不足
- タイムアウト（Vercel の実行時間制限に達した場合）
- 不正なパラメータ

### 5.3 フォールバック

- エラー時は、エラーメッセージを表示した画像を返却することを検討（ただし、初期フェーズでは JSON 形式のエラーレスポンスで十分）。

## 6. フォント設定

- **日本語フォント**: Noto Sans JP（Google Fonts）
- **英語フォント**: Inter / Roboto
- **フォントの読み込み**: Vercel でのデプロイ時にフォントファイルを同梱するか、CDN から読み込む方式を採用。
- **初期実装**: Satori で利用可能なフォント読み込み方式を使用。

## 7. 開発・デバッグ機能

### 7.1 デバッグモード

- **エンドポイント**: `GET /api/epaper?debug=true`
- **機能**:
  1. **減色前後の比較表示**: 元画像と減色後の画像を横並びで表示した比較画像を生成
  2. **パレット変換の可視化**: 各ピクセルがどのパレット色に変換されたかを色分けして表示
  3. **ディザリング効果の確認**: ディザリング有無の比較画像を生成
  4. **処理時間の表示**: 各処理ステップの実行時間を画像内にテキストで表示

### 7.2 開発時の利点

- 減色アルゴリズムの品質確認
- パレット設定の調整時の検証
- パフォーマンスの測定

## 8. ハードウェア連携（想定）

- **クライアント側**: ESP32 / Raspberry Pi などの Wi-Fi 対応マイコン。
- **連携方式**:

1. マイコンが一定間隔（例：1 時間ごと）で API を叩く。
2. 返ってきた PNG データをマイコン側でデコードし、SPI 通信でディスプレイに転送する。

## 9. キャッシュ戦略

### 9.1 キャッシュのメリット

**導入する場合のメリット**:

1. **サーバー負荷の軽減**: 同じ内容の画像生成リクエストに対して、再計算をスキップできる
2. **レスポンス時間の短縮**: キャッシュからの返却は数ミリ秒、新規生成は数秒かかるため大幅に高速化
3. **Vercel の実行時間制限の回避**: 頻繁なリクエストでも実行時間制限に達しにくくなる
4. **コスト削減**: Vercel の無料枠や従量課金での実行時間削減

**注意点**:

- 動的な内容（時刻表示など）を含む場合はキャッシュキーの設計が必要
- キャッシュの無効化タイミングの管理が必要

### 9.2 初期方針

- **最初はキャッシュなしで実装**し、パフォーマンスを測定した上で必要に応じて導入を検討する。
- 将来的には、クエリパラメータをキャッシュキーに含めた段階的なキャッシュ戦略を採用する。

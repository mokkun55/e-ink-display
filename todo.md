# 実装タスクリスト

## 📋 プロジェクトセットアップ

- [x] 必要な依存関係のインストール

  - [x] `sharp`（画像処理・Raw データ取得・エンコード用）
  - [x] 型定義（必要に応じて）
  - 注: `next/og`（Next.js 組み込み）で Satori と@resvg/resvg-js は不要

- [x] プロジェクト構成の確認
  - [x] Next.js App Router 構成の確認
  - [x] TypeScript 設定の確認

## 🎨 色パレット・設定

- [x] 色パレット設定ファイルの作成
  - [x] `src/config/palette.ts` または `src/config/palette.json` を作成
  - [x] 7 色パレットの定義（black, white, green, blue, red, yellow, orange）
  - [x] TypeScript 型定義の作成

## 🔤 フォント設定

- [x] フォントの準備
  - [x] Noto Sans JP フォントファイルの取得方法の調査
  - [x] Inter / Roboto フォントの取得
  - [x] `next/og` 用フォント読み込み関数の実装
  - [x] `src/utils/fonts.ts` の作成

## 🖼️ 画像生成処理の実装

- [x] 基本レンダリング機能

  - [x] `next/og` の `ImageResponse` を使った JSX → PNG 変換の実装
  - [x] 解像度 800x480px の設定
  - [x] 初期テスト用のシンプルな JSX テンプレート作成
  - 注: `next/og` が内部的に Satori と @resvg/resvg-js を使用

- [x] Raw データ取得

  - [x] sharp を使用した PNG → RGBA 配列の変換
  - [x] 画素データの取得・操作関数の実装 (`src/utils/image.ts`)

- [x] 減色処理アルゴリズム

  - [x] 7 色パレットへの近似関数（最近傍色の選択）
  - [x] フロイド-スタインバーグ・ディザリングの実装
  - [x] 誤差拡散処理の実装
  - [x] `src/utils/dithering.ts` の作成

- [x] PNG エンコード
  - [x] 減色後の RGBA 配列 → PNG バッファの変換
  - [x] sharp を使用したエンコード処理

## 🌐 API エンドポイント

- [x] `/api/epaper` エンドポイントの作成

  - [x] `src/app/api/epaper/route.tsx` の作成
  - [x] GET リクエストハンドラーの実装
  - [x] レスポンスヘッダーの設定（`Content-Type: image/png`）
  - [x] エラーハンドリングの実装

- [x] エラーレスポンスの実装
  - [x] HTTP ステータスコードの適切な設定（200, 400, 500）
  - [x] エラーレスポンス JSON 形式の実装
  - [x] エラーコードの定義

## 🎭 コンテンツレンダリング

- [x] 初期コンテンツの実装
  - [x] 「Hello World」テキストの表示
  - [x] 現在時刻の表示
  - [x] 簡単な図形の描画（矩形、円、三角形）
  - [x] 7 色テストパターンの作成
  - [x] `src/components/EpaperContent.tsx` の作成
  - [x] レイアウト調整（800x480px 内に収まるように最適化）

## 🐛 デバッグ機能

- [x] デバッグモードの実装
  - [x] `?debug=true` クエリパラメータの処理（比較画像生成）
  - [x] `?original=true` クエリパラメータの処理（元画像取得）
  - [x] `?debugInfoOnly=true` クエリパラメータの処理（デバッグ情報取得）
  - [x] 減色前後の比較画像の生成
  - [x] フロントエンドデバッグページ（`/debug`）の実装
  - [x] 処理時間の測定と表示

## 🧪 テスト・検証

- [x] 機能テスト（基本動作確認完了）

  - [x] ローカル環境での動作確認
  - [x] 生成された画像の確認（色が正しく表示されているか）
  - [x] エラーハンドリングのテスト（基本動作確認完了）
  - [x] デバッグモードの動作確認（フロントエンドページ実装完了）

- [ ] パフォーマンステスト
  - [ ] 処理時間の測定
  - [ ] メモリ使用量の確認
  - [ ] Vercel の実行時間制限との比較

## 🚀 デプロイ

- [ ] Vercel へのデプロイ準備

  - [ ] `vercel.json` の設定（必要に応じて）
  - [ ] 環境変数の確認（必要な場合）

- [ ] デプロイと動作確認
  - [ ] Vercel へのデプロイ
  - [ ] デプロイ後の動作確認
  - [ ] エラーログの確認

## 📝 ドキュメント

- [ ] README の更新

  - [ ] セットアップ手順の記載
  - [ ] API エンドポイントの説明
  - [ ] 使用方法の説明

- [ ] コードコメント
  - [ ] 主要な関数・クラスへの JSDoc コメント追加
  - [ ] 複雑な処理への説明コメント追加

## 🔮 将来の拡張（オプション）

- [ ] クエリパラメータ対応

  - [ ] 表示内容の動的変更機能
  - [ ] テキスト、日時、カラー選択などのパラメータ化

- [ ] キャッシュ機能の追加
  - [ ] キャッシュ戦略の設計
  - [ ] 実装とパフォーマンス測定

---

## 🎯 次のステップ（優先順位順）

### 1. 🔤 フォント設定（優先度: 高）

日本語フォント（Noto Sans JP）を実装して、日本語表示の品質を向上させる。

- [ ] Noto Sans JP フォントファイルの取得
- [ ] `src/utils/fonts.ts` の実装
- [ ] `next/og` の `ImageResponse` にフォントを適用
- [ ] フォント読み込みの動作確認

### 2. 🐛 デバッグ機能（優先度: 中）

減色処理の品質確認やパフォーマンス測定のためのデバッグモードを実装。

- [ ] `?debug=true` クエリパラメータの処理実装
- [ ] 減色前後の比較画像生成機能
- [ ] パレット変換の可視化機能
- [ ] 処理時間の測定と表示機能

### 3. 🧪 詳細テスト（優先度: 中）

本番環境に近い条件でのテストとパフォーマンス検証。

- [ ] エラーハンドリングの詳細テスト
- [ ] パフォーマンステスト（処理時間、メモリ使用量）
- [ ] 長時間動作テスト
- [ ] 異なるコンテンツパターンでのテスト

### 4. 🚀 デプロイ準備（優先度: 高）

Vercel へのデプロイと本番環境での動作確認。

- [ ] `vercel.json` の設定確認
- [ ] 環境変数の確認
- [ ] Vercel へのデプロイ
- [ ] 本番環境での動作確認
- [ ] エラーログの監視設定

### 5. 📝 ドキュメント整備（優先度: 低）

プロジェクトの保守性向上のためのドキュメント作成。

- [ ] README.md の更新（セットアップ手順、API 仕様）
- [ ] コードコメントの追加（JSDoc）
- [ ] アーキテクチャ説明の追加
